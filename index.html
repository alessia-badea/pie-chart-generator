<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pie Chart Generator</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">Pie Chart Generator</h1>

    <div class="card shadow p-4">
      <form id="data-form" class="mb-4" onsubmit="return false;">
        <div id="data-inputs">
          <div class="row mb-3 data-row">
            <div class="col-md-4">
              <input type="text" class="form-control" placeholder="Label (e.g. Sales)" required />
            </div>
            <div class="col-md-4">
              <input type="number" class="form-control" placeholder="Value (e.g. 120)" required />
            </div>
            <div class="col-md-3">
              <input type="color" class="form-control form-control-color" value="#ff6384" />
            </div>
            <div class="col-md-1 d-flex justify-content-center align-items-center">
              <button type="button" class="btn btn-danger remove-row">✖</button>
            </div>
          </div>
        </div>

        <button type="button" id="add-row" class="btn btn-outline-primary mb-3">
          ➕ Add Data Row
        </button>

        </form>

      <div class="text-center">
        <h4 class="mb-3">Preview</h4>
        <canvas id="pieChart" width="400" height="400" class="border rounded bg-white"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Data model: an array of { label: string, value: number, color: string }
    // This function reads the current rows from the form and returns the normalized data
    function collectDataRows() {
      const rows = document.querySelectorAll('#data-inputs .data-row');
      const data = [];
      rows.forEach(row => {
        const [labelInput, valueInput, colorInput] = row.querySelectorAll('input');
        const label = (labelInput?.value || '').trim();
        const value = Number(valueInput?.value);
        const color = colorInput?.value || '#000000';
        if (!label || !isFinite(value)) return; // skip incomplete rows
        data.push({ label, value, color });
      });
      return data;
    }

    
    // UI helpers
    function addDataRow({ label = '', value = '', color = '#ff6384' } = {}) {
      const container = document.getElementById('data-inputs');
      const row = document.createElement('div');
      row.className = 'row mb-3 data-row';
      row.innerHTML = `
        <div class="col-md-4">
          <input type="text" class="form-control" placeholder="Label (e.g. Sales)" required value="${label}" />
        </div>
        <div class="col-md-4">
          <input type="number" class="form-control" placeholder="Value (e.g. 120)" required value="${value}" />
        </div>
        <div class="col-md-3">
          <input type="color" class="form-control form-control-color" value="${color}" />
        </div>
        <div class="col-md-1 d-flex justify-content-center align-items-center">
          <button type="button" class="btn btn-danger remove-row">✖</button>
        </div>`;
      container.appendChild(row);
    }

    // Initialize add/remove behavior
    (function init() {
      const form = document.getElementById('data-form');
      const addBtn = document.getElementById('add-row');
      const inputsContainer = document.getElementById('data-inputs');

      // Start with one empty row
      inputsContainer.innerHTML = '';
      addDataRow();

      addBtn.addEventListener('click', () => {
        addDataRow();
        const data = collectDataRows();
        drawPieChart(data);
      });

      // Delegate remove row
      inputsContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-row');
        if (!btn) return;
        const row = btn.closest('.data-row');
        if (row) row.remove();
        const data = collectDataRows();
        drawPieChart(data);
      });

      // Save to storage when inputs change
      inputsContainer.addEventListener('input', () => {
        const data = collectDataRows();
        drawPieChart(data);
      });

      // No submit handler needed as chart updates live on input/add/remove
    })();

    // Canvas drawing logic
    function drawPieChart(data) {
      const canvas = document.getElementById('pieChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const cx = w / 2;
      const cy = h / 2;
      const radius = Math.min(w, h) * 0.45;

      // Clear canvas
      ctx.clearRect(0, 0, w, h);

      // Guard: no data or zero total
      const total = data.reduce((sum, d) => sum + Math.max(0, d.value || 0), 0);
      if (!data.length || total <= 0) {
        ctx.fillStyle = '#888';
        ctx.font = '16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Add data and click Generate Chart', cx, cy);
        return;
      }

      let startAngle = -Math.PI / 2; // start at top for nicer orientation

      // Draw slices
      const eps = 0.001; // tiny overlap to eliminate gaps
      data.forEach(item => {
        const sliceAngle = (Math.max(0, item.value || 0) / total) * Math.PI * 2;
        const endAngle = startAngle + sliceAngle;

        // Slice with slight overlap
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, radius, startAngle - eps, endAngle + eps);
        ctx.closePath();
        ctx.fillStyle = item.color || '#000';
        ctx.fill();

        // Label
        if (sliceAngle > 0.03) { // skip very small slices to reduce clutter
          const mid = (startAngle + endAngle) / 2;
          const labelRadius = radius * 0.65;
          const lx = cx + Math.cos(mid) * labelRadius;
          const ly = cy + Math.sin(mid) * labelRadius;
          const percent = ((item.value / total) * 100).toFixed(1) + '%';

          ctx.fillStyle = '#000';
          ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(`${item.label} (${percent})`, lx, ly);
        }

        startAngle = endAngle;
      });

      // Optional: draw center circle for donut effect (commented)
      // ctx.globalCompositeOperation = 'destination-out';
      // ctx.beginPath();
      // ctx.arc(cx, cy, radius * 0.5, 0, Math.PI * 2);
      // ctx.fill();
      // ctx.globalCompositeOperation = 'source-over';
    }
  </script>
</body>
</html>
